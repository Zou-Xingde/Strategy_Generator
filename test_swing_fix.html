<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¢æ®µé¡¯ç¤ºä¿®å¾©æ¸¬è©¦</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            height: 400px;
            margin: 20px 0;
            border: 1px solid #333;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #2d3748;
            border-radius: 8px;
        }
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #3182ce;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #4a5568;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¯ æ³¢æ®µé¡¯ç¤ºä¿®å¾©æ¸¬è©¦</h1>
        
        <div class="controls">
            <h3>æ§åˆ¶é¢æ¿</h3>
            <button onclick="testSwingDisplay()">æ¸¬è©¦æ³¢æ®µé¡¯ç¤º</button>
            <button onclick="clearSwing()">æ¸…é™¤æ³¢æ®µ</button>
            <button onclick="testDropdown()">æ¸¬è©¦ä¸‹æ‹‰é¸å–®</button>
        </div>
        
        <div class="status" id="status">
            ç‹€æ…‹: æº–å‚™å°±ç·’
        </div>
        
        <div class="chart-container" id="chart"></div>
    </div>

    <script>
        let chart;
        let swingPoints = [];
        let swingLines = [];
        
        // åˆå§‹åŒ–åœ–è¡¨
        function initChart() {
            const chartContainer = document.getElementById('chart');
            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.offsetWidth,
                height: chartContainer.offsetHeight,
                layout: {
                    background: { color: '#1a1a1a' },
                    textColor: '#ffffff',
                },
                grid: {
                    vertLines: { color: '#2d3748' },
                    horzLines: { color: '#2d3748' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#2d3748',
                },
                timeScale: {
                    borderColor: '#2d3748',
                },
            });
            
            // æ·»åŠ è Ÿç‡­åœ–ç³»åˆ—
            const candlestickSeries = chart.addCandlestickSeries({
                upColor: '#00cc00',
                downColor: '#ff4444',
                borderVisible: false,
                wickUpColor: '#00cc00',
                wickDownColor: '#ff4444',
            });
            
            // æ·»åŠ ä¸€äº›æ¸¬è©¦æ•¸æ“š
            const testData = [
                { time: '2023-01-01', open: 1800, high: 1820, low: 1790, close: 1810 },
                { time: '2023-01-02', open: 1810, high: 1830, low: 1800, close: 1825 },
                { time: '2023-01-03', open: 1825, high: 1840, low: 1815, close: 1835 },
                { time: '2023-01-04', open: 1835, high: 1850, low: 1820, close: 1845 },
                { time: '2023-01-05', open: 1845, high: 1860, low: 1830, close: 1855 },
                { time: '2023-01-06', open: 1855, high: 1870, low: 1840, close: 1865 },
                { time: '2023-01-07', open: 1865, high: 1880, low: 1850, close: 1875 },
            ];
            
            candlestickSeries.setData(testData);
            
            updateStatus('åœ–è¡¨å·²åˆå§‹åŒ–');
        }
        
        // æ¸¬è©¦æ³¢æ®µé¡¯ç¤º
        async function testSwingDisplay() {
            try {
                updateStatus('æ­£åœ¨è¼‰å…¥æ³¢æ®µè³‡æ–™...');
                
                const response = await fetch('/api/swing/XAUUSD/D1');
                const data = await response.json();
                
                if (data.error) {
                    updateStatus('éŒ¯èª¤: ' + data.error);
                    return;
                }
                
                if (!data.data || data.data.length === 0) {
                    updateStatus('æ²’æœ‰æ‰¾åˆ°æ³¢æ®µè³‡æ–™');
                    return;
                }
                
                // æ¸…é™¤ç¾æœ‰æ³¢æ®µ
                clearSwing();
                
                // æŒ‰æ™‚é–“æ’åº
                const sortedData = data.data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                // å‰µå»ºæ³¢æ®µé»
                const swingPointsData = sortedData.map(point => ({
                    time: Math.floor(new Date(point.timestamp).getTime() / 1000),
                    value: point.zigzag_price,
                    type: point.zigzag_type
                }));
                
                // æ·»åŠ æ³¢æ®µé»æ¨™è¨˜ - ä½¿ç”¨æ•£é»åœ–
                swingPointsData.forEach((point, index) => {
                    const markerSeries = chart.addScatterPlotSeries({
                        color: point.type === 'high' ? '#ff4444' : '#00cc00',
                        size: 10,
                        shape: 'circle',
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        lastValueVisible: false,
                        priceLineVisible: false,
                    });
                    
                    const markerData = [{
                        time: point.time,
                        value: point.value
                    }];
                    
                    markerSeries.setData(markerData);
                    swingPoints.push(markerSeries);
                });
                
                // å‰µå»ºé€£æ¥ç·š
                for (let i = 0; i < swingPointsData.length - 1; i++) {
                    const currentPoint = swingPointsData[i];
                    const nextPoint = swingPointsData[i + 1];
                    
                    const lineSeries = chart.addLineSeries({
                        color: getSwingLineColor(currentPoint.type, nextPoint.type),
                        lineWidth: 3,
                        lineStyle: LightweightCharts.LineStyle.Dashed,
                        crosshairMarkerVisible: false,
                        lastValueVisible: false,
                        priceLineVisible: false,
                    });
                    
                    const lineData = [
                        { time: currentPoint.time, value: currentPoint.value },
                        { time: nextPoint.time, value: nextPoint.value }
                    ];
                    
                    lineSeries.setData(lineData);
                    swingLines.push(lineSeries);
                }
                
                updateStatus(`æˆåŠŸé¡¯ç¤º ${swingPointsData.length} å€‹æ³¢æ®µé»å’Œ ${swingLines.length} æ¢é€£æ¥ç·š`);
                
            } catch (error) {
                updateStatus('éŒ¯èª¤: ' + error.message);
                console.error('æ¸¬è©¦æ³¢æ®µé¡¯ç¤ºå¤±æ•—:', error);
            }
        }
        
        // æ¸…é™¤æ³¢æ®µ
        function clearSwing() {
            swingPoints.forEach(point => {
                if (point && chart) {
                    try {
                        chart.removeSeries(point);
                    } catch (e) {
                        console.warn('Error removing swing point:', e);
                    }
                }
            });
            swingPoints = [];
            
            swingLines.forEach(line => {
                if (line && chart) {
                    try {
                        chart.removeSeries(line);
                    } catch (e) {
                        console.warn('Error removing swing line:', e);
                    }
                }
            });
            swingLines = [];
            
            updateStatus('å·²æ¸…é™¤æ‰€æœ‰æ³¢æ®µé¡¯ç¤º');
        }
        
        // ç²å–æ³¢æ®µç·šé¡è‰²
        function getSwingLineColor(type1, type2) {
            if (type1 === 'low' && type2 === 'high') {
                return '#00cc00'; // ä¸Šå‡æ³¢æ®µ - ç¶ è‰²
            } else if (type1 === 'high' && type2 === 'low') {
                return '#ff4444'; // ä¸‹é™æ³¢æ®µ - ç´…è‰²
            } else {
                return '#888888'; // é»˜èªç°è‰²
            }
        }
        
        // æ¸¬è©¦ä¸‹æ‹‰é¸å–®
        function testDropdown() {
            updateStatus('ä¸‹æ‹‰é¸å–®æ¸¬è©¦: è«‹æª¢æŸ¥ä¸»é é¢çš„ä¸‹æ‹‰é¸å–®æ˜¯å¦æ­£å¸¸å·¥ä½œ');
        }
        
        // æ›´æ–°ç‹€æ…‹
        function updateStatus(message) {
            document.getElementById('status').textContent = 'ç‹€æ…‹: ' + message;
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('load', () => {
            initChart();
        });
        
        // éŸ¿æ‡‰å¼èª¿æ•´
        window.addEventListener('resize', () => {
            if (chart) {
                chart.applyOptions({
                    width: document.getElementById('chart').offsetWidth,
                    height: document.getElementById('chart').offsetHeight,
                });
            }
        });
    </script>
</body>
</html> 