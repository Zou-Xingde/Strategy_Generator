<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>波段顯示修復測試</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            height: 400px;
            margin: 20px 0;
            border: 1px solid #333;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #2d3748;
            border-radius: 8px;
        }
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #3182ce;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #4a5568;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🎯 波段顯示修復測試</h1>
        
        <div class="controls">
            <h3>控制面板</h3>
            <button onclick="testSwingDisplay()">測試波段顯示</button>
            <button onclick="clearSwing()">清除波段</button>
            <button onclick="testDropdown()">測試下拉選單</button>
        </div>
        
        <div class="status" id="status">
            狀態: 準備就緒
        </div>
        
        <div class="chart-container" id="chart"></div>
    </div>

    <script>
        let chart;
        let swingPoints = [];
        let swingLines = [];
        
        // 初始化圖表
        function initChart() {
            const chartContainer = document.getElementById('chart');
            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.offsetWidth,
                height: chartContainer.offsetHeight,
                layout: {
                    background: { color: '#1a1a1a' },
                    textColor: '#ffffff',
                },
                grid: {
                    vertLines: { color: '#2d3748' },
                    horzLines: { color: '#2d3748' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#2d3748',
                },
                timeScale: {
                    borderColor: '#2d3748',
                },
            });
            
            // 添加蠟燭圖系列
            const candlestickSeries = chart.addCandlestickSeries({
                upColor: '#00cc00',
                downColor: '#ff4444',
                borderVisible: false,
                wickUpColor: '#00cc00',
                wickDownColor: '#ff4444',
            });
            
            // 添加一些測試數據
            const testData = [
                { time: '2023-01-01', open: 1800, high: 1820, low: 1790, close: 1810 },
                { time: '2023-01-02', open: 1810, high: 1830, low: 1800, close: 1825 },
                { time: '2023-01-03', open: 1825, high: 1840, low: 1815, close: 1835 },
                { time: '2023-01-04', open: 1835, high: 1850, low: 1820, close: 1845 },
                { time: '2023-01-05', open: 1845, high: 1860, low: 1830, close: 1855 },
                { time: '2023-01-06', open: 1855, high: 1870, low: 1840, close: 1865 },
                { time: '2023-01-07', open: 1865, high: 1880, low: 1850, close: 1875 },
            ];
            
            candlestickSeries.setData(testData);
            
            updateStatus('圖表已初始化');
        }
        
        // 測試波段顯示
        async function testSwingDisplay() {
            try {
                updateStatus('正在載入波段資料...');
                
                const response = await fetch('/api/swing/XAUUSD/D1');
                const data = await response.json();
                
                if (data.error) {
                    updateStatus('錯誤: ' + data.error);
                    return;
                }
                
                if (!data.data || data.data.length === 0) {
                    updateStatus('沒有找到波段資料');
                    return;
                }
                
                // 清除現有波段
                clearSwing();
                
                // 按時間排序
                const sortedData = data.data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                // 創建波段點
                const swingPointsData = sortedData.map(point => ({
                    time: Math.floor(new Date(point.timestamp).getTime() / 1000),
                    value: point.zigzag_price,
                    type: point.zigzag_type
                }));
                
                // 添加波段點標記 - 使用散點圖
                swingPointsData.forEach((point, index) => {
                    const markerSeries = chart.addScatterPlotSeries({
                        color: point.type === 'high' ? '#ff4444' : '#00cc00',
                        size: 10,
                        shape: 'circle',
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        lastValueVisible: false,
                        priceLineVisible: false,
                    });
                    
                    const markerData = [{
                        time: point.time,
                        value: point.value
                    }];
                    
                    markerSeries.setData(markerData);
                    swingPoints.push(markerSeries);
                });
                
                // 創建連接線
                for (let i = 0; i < swingPointsData.length - 1; i++) {
                    const currentPoint = swingPointsData[i];
                    const nextPoint = swingPointsData[i + 1];
                    
                    const lineSeries = chart.addLineSeries({
                        color: getSwingLineColor(currentPoint.type, nextPoint.type),
                        lineWidth: 3,
                        lineStyle: LightweightCharts.LineStyle.Dashed,
                        crosshairMarkerVisible: false,
                        lastValueVisible: false,
                        priceLineVisible: false,
                    });
                    
                    const lineData = [
                        { time: currentPoint.time, value: currentPoint.value },
                        { time: nextPoint.time, value: nextPoint.value }
                    ];
                    
                    lineSeries.setData(lineData);
                    swingLines.push(lineSeries);
                }
                
                updateStatus(`成功顯示 ${swingPointsData.length} 個波段點和 ${swingLines.length} 條連接線`);
                
            } catch (error) {
                updateStatus('錯誤: ' + error.message);
                console.error('測試波段顯示失敗:', error);
            }
        }
        
        // 清除波段
        function clearSwing() {
            swingPoints.forEach(point => {
                if (point && chart) {
                    try {
                        chart.removeSeries(point);
                    } catch (e) {
                        console.warn('Error removing swing point:', e);
                    }
                }
            });
            swingPoints = [];
            
            swingLines.forEach(line => {
                if (line && chart) {
                    try {
                        chart.removeSeries(line);
                    } catch (e) {
                        console.warn('Error removing swing line:', e);
                    }
                }
            });
            swingLines = [];
            
            updateStatus('已清除所有波段顯示');
        }
        
        // 獲取波段線顏色
        function getSwingLineColor(type1, type2) {
            if (type1 === 'low' && type2 === 'high') {
                return '#00cc00'; // 上升波段 - 綠色
            } else if (type1 === 'high' && type2 === 'low') {
                return '#ff4444'; // 下降波段 - 紅色
            } else {
                return '#888888'; // 默認灰色
            }
        }
        
        // 測試下拉選單
        function testDropdown() {
            updateStatus('下拉選單測試: 請檢查主頁面的下拉選單是否正常工作');
        }
        
        // 更新狀態
        function updateStatus(message) {
            document.getElementById('status').textContent = '狀態: ' + message;
        }
        
        // 頁面載入完成後初始化
        window.addEventListener('load', () => {
            initChart();
        });
        
        // 響應式調整
        window.addEventListener('resize', () => {
            if (chart) {
                chart.applyOptions({
                    width: document.getElementById('chart').offsetWidth,
                    height: document.getElementById('chart').offsetHeight,
                });
            }
        });
    </script>
</body>
</html> 