<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>波段顯示調試測試</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            height: 400px;
            margin: 20px 0;
            border: 1px solid #333;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #2d3748;
            border-radius: 8px;
        }
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #3182ce;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #4a5568;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔍 波段顯示調試測試</h1>
        
        <div class="controls">
            <h3>控制面板</h3>
            <button onclick="testAPI()">測試API</button>
            <button onclick="testSwingDisplay()">測試波段顯示</button>
            <button onclick="clearSwing()">清除波段</button>
            <button onclick="clearLog()">清除日誌</button>
        </div>
        
        <div class="status" id="status">
            狀態: 準備調試波段顯示
        </div>
        
        <div class="chart-container" id="chart"></div>
    </div>

    <script>
        let chart;
        let swingPoints = [];
        let swingLines = [];
        
        function updateStatus(message) {
            const status = document.getElementById('status');
            status.textContent += '\n' + new Date().toLocaleTimeString() + ': ' + message;
            status.scrollTop = status.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('status').textContent = '狀態: 日誌已清除';
        }
        
        // 初始化圖表
        function initChart() {
            const chartContainer = document.getElementById('chart');
            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.offsetWidth,
                height: chartContainer.offsetHeight,
                layout: {
                    background: { color: '#1a1a1a' },
                    textColor: '#ffffff',
                },
                grid: {
                    vertLines: { color: '#2d3748' },
                    horzLines: { color: '#2d3748' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#2d3748',
                },
                timeScale: {
                    borderColor: '#2d3748',
                },
            });
            
            // 添加蠟燭圖系列
            const candlestickSeries = chart.addCandlestickSeries({
                upColor: '#00cc00',
                downColor: '#ff4444',
                borderVisible: false,
                wickUpColor: '#00cc00',
                wickDownColor: '#ff4444',
            });
            
            // 添加一些測試數據
            const testData = [
                { time: '2023-01-01', open: 1800, high: 1820, low: 1790, close: 1810 },
                { time: '2023-01-02', open: 1810, high: 1830, low: 1800, close: 1825 },
                { time: '2023-01-03', open: 1825, high: 1840, low: 1815, close: 1835 },
                { time: '2023-01-04', open: 1835, high: 1850, low: 1820, close: 1845 },
                { time: '2023-01-05', open: 1845, high: 1860, low: 1830, close: 1855 },
                { time: '2023-01-06', open: 1855, high: 1870, low: 1840, close: 1865 },
                { time: '2023-01-07', open: 1865, high: 1880, low: 1850, close: 1875 },
            ];
            
            candlestickSeries.setData(testData);
            updateStatus('圖表已初始化');
        }
        
        // 測試API
        async function testAPI() {
            try {
                updateStatus('正在測試API...');
                
                const response = await fetch('/api/swing/XAUUSD/D1?algorithm=zigzag');
                updateStatus(`API響應狀態: ${response.status}`);
                
                const data = await response.json();
                updateStatus(`API響應數據類型: ${typeof data}`);
                updateStatus(`API響應數據: ${JSON.stringify(data, null, 2)}`);
                
                if (data.data && data.data.length > 0) {
                    updateStatus(`找到 ${data.data.length} 個波段點`);
                    updateStatus(`第一個波段點: ${JSON.stringify(data.data[0], null, 2)}`);
                } else {
                    updateStatus('沒有找到波段數據');
                }
                
            } catch (error) {
                updateStatus(`API測試失敗: ${error.message}`);
                console.error('API測試錯誤:', error);
            }
        }
        
        // 測試波段顯示
        async function testSwingDisplay() {
            try {
                updateStatus('正在測試波段顯示...');
                
                const response = await fetch('/api/swing/XAUUSD/D1?algorithm=zigzag');
                const data = await response.json();
                
                if (data.error) {
                    updateStatus(`API錯誤: ${data.error}`);
                    return;
                }
                
                if (!data.data || data.data.length === 0) {
                    updateStatus('沒有找到波段數據');
                    return;
                }
                
                // 清除現有波段
                clearSwing();
                
                // 按時間排序
                const sortedData = data.data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                updateStatus(`排序後數據數量: ${sortedData.length}`);
                
                // 創建波段點數據
                const swingPointsData = sortedData.map(point => {
                    let timestamp;
                    if (typeof point.timestamp === 'string') {
                        timestamp = new Date(point.timestamp);
                    } else if (typeof point.timestamp === 'number') {
                        timestamp = new Date(point.timestamp * 1000);
                    } else {
                        timestamp = new Date();
                    }
                    
                    return {
                        time: Math.floor(timestamp.getTime() / 1000),
                        value: parseFloat(point.zigzag_price),
                        type: point.zigzag_type
                    };
                });
                
                updateStatus(`處理後波段點數量: ${swingPointsData.length}`);
                updateStatus(`第一個處理後的波段點: ${JSON.stringify(swingPointsData[0], null, 2)}`);
                
                // 添加波段點標記
                swingPointsData.forEach((point, index) => {
                    updateStatus(`添加波段點 ${index + 1}: ${point.type} at ${point.time}`);
                    
                    const markerSeries = chart.addScatterPlotSeries({
                        color: point.type === 'high' ? '#ff4444' : '#00cc00',
                        size: 15,
                        shape: 'circle',
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        lastValueVisible: false,
                        priceLineVisible: false,
                    });
                    
                    const markerData = [{
                        time: point.time,
                        value: point.value
                    }];
                    
                    markerSeries.setData(markerData);
                    swingPoints.push(markerSeries);
                });
                
                // 創建連接線
                for (let i = 0; i < swingPointsData.length - 1; i++) {
                    const currentPoint = swingPointsData[i];
                    const nextPoint = swingPointsData[i + 1];
                    
                    updateStatus(`添加連接線 ${i + 1}: ${currentPoint.time} -> ${nextPoint.time}`);
                    
                    const lineSeries = chart.addLineSeries({
                        color: getSwingLineColor(currentPoint.type, nextPoint.type),
                        lineWidth: 3,
                        lineStyle: LightweightCharts.LineStyle.Dashed,
                        crosshairMarkerVisible: false,
                        lastValueVisible: false,
                        priceLineVisible: false,
                    });
                    
                    const lineData = [
                        { time: currentPoint.time, value: currentPoint.value },
                        { time: nextPoint.time, value: nextPoint.value }
                    ];
                    
                    lineSeries.setData(lineData);
                    swingLines.push(lineSeries);
                }
                
                updateStatus(`成功顯示 ${swingPointsData.length} 個波段點和 ${swingLines.length} 條連接線`);
                
            } catch (error) {
                updateStatus(`波段顯示測試失敗: ${error.message}`);
                console.error('波段顯示測試錯誤:', error);
            }
        }
        
        // 清除波段
        function clearSwing() {
            swingPoints.forEach(point => {
                if (point && chart) {
                    try {
                        chart.removeSeries(point);
                    } catch (e) {
                        console.warn('Error removing swing point:', e);
                    }
                }
            });
            swingPoints = [];
            
            swingLines.forEach(line => {
                if (line && chart) {
                    try {
                        chart.removeSeries(line);
                    } catch (e) {
                        console.warn('Error removing swing line:', e);
                    }
                }
            });
            swingLines = [];
            
            updateStatus('已清除所有波段顯示');
        }
        
        // 獲取波段線顏色
        function getSwingLineColor(type1, type2) {
            if (type1 === 'low' && type2 === 'high') {
                return '#00cc00'; // 上升波段 - 綠色
            } else if (type1 === 'high' && type2 === 'low') {
                return '#ff4444'; // 下降波段 - 紅色
            } else {
                return '#888888'; // 默認灰色
            }
        }
        
        // 頁面載入完成後初始化
        window.addEventListener('load', () => {
            updateStatus('頁面已載入，準備初始化圖表');
            initChart();
        });
        
        // 響應式調整
        window.addEventListener('resize', () => {
            if (chart) {
                chart.applyOptions({
                    width: document.getElementById('chart').offsetWidth,
                    height: document.getElementById('chart').offsetHeight,
                });
            }
        });
    </script>
</body>
</html> 